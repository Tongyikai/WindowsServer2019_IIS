<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç°½åˆ°å¸ƒå‘Šæ¬„ï¼ˆå‹•æ¼«é¢¨ï¼‰</title>
  <style>
    :root{
      /* åœ¨é€™è£¡æ›ä½ çš„èƒŒæ™¯åœ–ï¼ˆå»ºè­° 1920x1080 ä»¥ä¸Šï¼‰ */
      --anime-bg: url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop'); /* ä¾‹ï¼šè—å¤©é›²å½© */
      --glass-bg: rgba(255,255,255,0.72);
      --glass-stroke: rgba(255,255,255,0.9);
      --shadow: 0 20px 50px rgba(0,0,0,0.25);
      --primary: #5b6cff;
      --accent: #ff62a5;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:#1f2937;
      /* å‹•æ¼«é¢¨èƒŒæ™¯ï¼šåœ–ï¼‹æ¼¸å±¤ï¼‹ç¶²é» */
      background:
        radial-gradient(60vmax 60vmax at 20% 10%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(50vmax 50vmax at 80% 20%, rgba(255,192,203,0.25), transparent 60%),
        radial-gradient(60vmax 60vmax at 30% 80%, rgba(135,206,250,0.25), transparent 60%),
        var(--anime-bg) center/cover no-repeat fixed;
      position: relative;
      overflow-x: hidden;
    }
    /* æ¼«ç•«ç¶²é»ç–ŠåŠ ï¼ˆä¸æ¶çœ¼ï¼‰ */
    body::before{
      content:"";
      position: fixed; inset:0;
      background-image: radial-gradient(rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 6px 6px;
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .container{
      max-width: 980px;
      margin: min(8vh,64px) auto;
      padding: 0 16px 48px;
    }
    .header{
      text-align:center;
      color:#0f172a;
      text-shadow: 0 2px 12px rgba(255,255,255,0.65);
      margin-bottom: 18px;
    }
    .title{
      font-size: clamp(28px, 4vw, 42px);
      margin: 0 0 6px;
      letter-spacing: 0.5px;
    }
    .subtitle{
      margin:0;
      opacity:0.8;
    }

    .panel{
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-stroke);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .form{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: end;
    }
    .field{
      display:flex; flex-direction: column; gap:6px;
    }
    label{ font-size: 14px; color:#374151; }
    input[type="text"]{
      width:100%;
      font-size:16px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      outline:none;
      background: #fff;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    input[type="text"]:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(91,108,255,0.2);
    }
    .btn{
      cursor:pointer;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      box-shadow: 0 8px 20px rgba(255,98,165,0.35);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn[disabled]{ filter: grayscale(0.5) brightness(0.8); cursor: not-allowed; }

    .tip{
      margin-top:8px;
      font-size: 13px;
      color:#6b7280;
    }

    .list{
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    .card{
      background: #ffffffd9;
      border: 1px solid #eef2ff;
      border-left: 6px solid var(--primary);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
    }
    .name{ font-weight:800; font-size: 18px; margin-bottom: 6px; color:#111827; }
    .meta{ font-size: 13px; color:#374151; line-height: 1.4; }
    .meta a{ color:#1f3fff; text-decoration: none; }
    .bar{
      margin-top: 14px;
      display:flex; gap:8px; justify-content: flex-end; flex-wrap: wrap;
    }
    .ghost{
      border-radius: 10px;
      border:1px dashed rgba(31,41,55,.25);
      background: rgba(255,255,255,.6);
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    /* å°è¢å¹•å„ªåŒ– */
    @media (max-width:480px){
      .form{ grid-template-columns: 1fr; }
      .bar{ justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">ç°½åˆ°å¸ƒå‘Šæ¬„</h1>
      <p class="subtitle">å¯«ä¸‹ä½ çš„åå­—ï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„ã€Œæ—¥æœŸæ™‚é–“èˆ‡åœ°é»ã€ã€‚</p>
    </header>

    <section class="panel">
      <form id="signForm" class="form" autocomplete="off">
        <div class="field">
          <label for="name">åå­— / æš±ç¨±</label>
          <input id="name" type="text" placeholder="ä¾‹ï¼šå°æ™ºã€é˜¿è‰¯ã€Ryanâ€¦" required />
          <div class="tip">æç¤ºï¼šåŒåä¹Ÿå¯ä»¥é‡è¤‡ç°½åˆ°ï¼Œæœƒç•¶æˆæ–°çš„ä¸€ç­†ã€‚</div>
        </div>
        <button id="signBtn" class="btn" type="submit">ç°½åˆ°ï¼</button>
      </form>
      <div class="bar">
        <button id="exportBtn" class="ghost" type="button">åŒ¯å‡º CSV</button>
        <button id="clearBtn" class="ghost" type="button" title="åªæ¸…é™¤æœ¬æ©Ÿä¿å­˜çš„æ¸…å–®">æ¸…é™¤æ¸…å–®</button>
      </div>
      <div id="status" class="tip" aria-live="polite" style="margin-top:10px;"></div>
      <div id="list" class="list" aria-live="polite" aria-busy="false"></div>
    </section>
  </div>

  <script>
    // ===== å·¥å…·å‡½å¼ =====
    const el = (sel)=>document.querySelector(sel);
    const fmtTime = (d)=> new Intl.DateTimeFormat('zh-TW',{
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit',
      hour12:false, timeZoneName:'short'
    }).format(d);

    function getGeoOnce(timeoutMs=8000){
      return new Promise((resolve)=>{
        if(!('geolocation' in navigator)){
          resolve({ ok:false, reason:'æœ¬è£ç½®ä¸æ”¯æ´å®šä½' });
          return;
        }
        const onOk = (pos)=>{
          const { latitude, longitude, accuracy } = pos.coords;
          resolve({ ok:true, latitude, longitude, accuracy });
        };
        const onErr = (err)=>{
          resolve({ ok:false, reason: err.message || 'ç„¡æ³•å–å¾—å®šä½' });
        };
        navigator.geolocation.getCurrentPosition(onOk, onErr, {
          enableHighAccuracy: true,
          timeout: timeoutMs,
          maximumAge: 0
        });
      });
    }

    // ===== è³‡æ–™ä¿å­˜ =====
    const KEY = 'animeSignBoard.v1';
    const load = ()=> {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    };
    const save = (arr)=> localStorage.setItem(KEY, JSON.stringify(arr));

    // ===== UI èˆ‡äº‹ä»¶ =====
    const state = { list: load() };
    const listEl = el('#list');
    const statusEl = el('#status');
    const btn = el('#signBtn');
    const nameInput = el('#name');

    function setStatus(msg){ statusEl.textContent = msg || ''; }

    function render(){
      listEl.innerHTML = '';
      if(state.list.length === 0){
        const empty = document.createElement('div');
        empty.className = 'tip';
        empty.textContent = 'ç›®å‰é‚„æ²’æœ‰ä»»ä½•ç°½åˆ°ï¼Œæˆç‚ºç¬¬ä¸€å€‹å§ï¼';
        listEl.appendChild(empty);
        return;
      }
      for(const item of state.list){
        const card = document.createElement('div');
        card.className = 'card';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.name;

        const meta = document.createElement('div');
        meta.className = 'meta';

        const timeLine = document.createElement('div');
        timeLine.textContent = `æ™‚é–“ï¼š${item.time}`;

        const placeLine = document.createElement('div');
        if(item.loc && item.loc.lat && item.loc.lon){
          const lat = Number(item.loc.lat).toFixed(5);
          const lon = Number(item.loc.lon).toFixed(5);
          const acc = item.loc.acc ? `ï¼ˆÂ±${Math.round(item.loc.acc)}mï¼‰` : '';
          const link = document.createElement('a');
          link.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}`;
          link.target = '_blank';
          link.rel = 'noopener';
          link.textContent = `(${lat}, ${lon})`;
          placeLine.append('åœ°é»ï¼š', link, acc);
        } else {
          placeLine.textContent = `åœ°é»ï¼šæœªæä¾›`;
        }

        meta.append(timeLine, placeLine);
        card.append(name, meta);
        listEl.appendChild(card);
      }
    }

    async function onSubmit(e){
      e.preventDefault();
      const name = nameInput.value.trim();
      if(!name){
        setStatus('è«‹å…ˆè¼¸å…¥åå­—ã€‚');
        nameInput.focus();
        return;
      }
      btn.disabled = true;
      setStatus('æ­£åœ¨å–å¾—å®šä½ï¼ˆå¯æ‹’çµ•ï¼‰ï¼Œä¸¦è¨˜éŒ„æ™‚é–“â€¦');

      const now = new Date();
      const geo = await getGeoOnce(8000);
      const entry = {
        name,
        time: fmtTime(now),
        ts: now.getTime(),
        loc: geo.ok ? { lat: geo.latitude, lon: geo.longitude, acc: geo.accuracy } : null
      };
      state.list.unshift(entry);
      save(state.list);
      render();
      setStatus(geo.ok ? 'ç°½åˆ°å®Œæˆï¼âœ…' : 'ç°½åˆ°å®Œæˆï¼ˆæœªå–å¾—å®šä½ï¼‰ğŸ“');
      nameInput.value = '';
      nameInput.focus();
      btn.disabled = false;
    }

    function toCSV(rows){
      const header = ['name','time','latitude','longitude','accuracy(m)'];
      const lines = [header.join(',')];
      for(const r of rows){
        const lat = r?.loc?.lat ?? '';
        const lon = r?.loc?.lon ?? '';
        const acc = r?.loc?.acc ?? '';
        lines.push([r.name, r.time, lat, lon, acc].join(','));
      }
      return '\uFEFF' + lines.join('\n'); // \uFEFF è®“ Excel æ­£ç¢ºè¾¨è­˜ UTF-8
    }

    function download(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    // ç¶å®šäº‹ä»¶
    el('#signForm').addEventListener('submit', onSubmit);
    el('#clearBtn').addEventListener('click', ()=>{
      if(confirm('ç¢ºå®šè¦æ¸…é™¤æ¸…å–®å—ï¼Ÿï¼ˆåªå½±éŸ¿æœ¬æ©Ÿè³‡æ–™ï¼‰')){
        state.list = []; save(state.list); render(); setStatus('å·²æ¸…é™¤æ¸…å–®ã€‚');
      }
    });
    el('#exportBtn').addEventListener('click', ()=>{
      if(state.list.length === 0){ setStatus('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºã€‚'); return; }
      download('ç°½åˆ°æ¸…å–®.csv', toCSV(state.list));
      setStatus('å·²åŒ¯å‡º CSVã€‚');
    });

    // åˆå§‹åŒ–
    render();
  </script>
</body>
</html>
